name: Build Android

# Controls when the workflow will run
on:
  # Triggers the workflow on push events but only for the "main" branch
  # push:
  #   branches: [ "main" ]
  # pull_request:
  #   branches: [ "main" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build-android:
    name: Build Android
    runs-on: macOS-latest
    steps:
      - name: ğŸ—ï¸ Setup c-breez repository
        uses: actions/checkout@v4
        with:
          path: 'cbreez'

      - name: ğŸ—ï¸ Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: ğŸ—ï¸ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: ğŸ—ï¸ Android cache
        id: android-cache
        uses: actions/cache@v3
        with:
          path: ~/.android/debug.keystore
          key: debug.keystore

      - name: ğŸ—ï¸ Copy Firebase configuration file
        working-directory: cbreez
        env:
          GOOGLE_SERVICES: ${{secrets.GOOGLE_SERVICES}}
        run: echo "$GOOGLE_SERVICES" > android/app/google-services.json

      - name: ğŸ—ï¸ Setup breez-sdk repository
        uses: actions/checkout@v4
        with:
          repository: 'breez/breez-sdk'
          ssh-key: ${{secrets.REPO_SSH_KEY}}
          path: 'breez-sdk'

      - name: ğŸ“¦ Install Breez SDK dependencies
        run: |
          cargo install cargo-ndk@2.12.2
          brew install protobuf
          cd breez-sdk/libs/sdk-flutter
          make init
          cd ../sdk-core
          make init

      - name: ğŸ”¨ Build Breez SDK
        env:
          SSH_PRIVATE_KEY: ${{secrets.REPO_SSH_KEY}}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          sudo chmod 600 ~/.ssh/id_rsa
          ssh-add ~/.ssh/id_rsa
          cd breez-sdk/libs/sdk-flutter
          make android    

      - name: ğŸ—‚ï¸ Populate Flutter tool's cache of binary artifacts.
        run: flutter precache

      - name: ğŸ“¦ Install Flutter dependencies
        run: flutter pub get

      - name: ğŸ” Perform static analysis
        working-directory: cbreez
        run: dart analyze --fatal-infos

      - name: ğŸ› ï¸ Run tests
        working-directory: cbreez
        run: flutter test

      - name: âš™ï¸ Setup compile-time variables
        env:
          CONFIG_FILE: ${{secrets.CONFIG_FILE}}
        run: echo "$CONFIG_FILE" > ./cbreez/config.json

      - name: ğŸš€ Build Release apk
        working-directory: cbreez
        run: flutter build apk --release --split-debug-info=./obsfucated/debug --obfuscate --no-pub --split-per-abi --dart-define-from-file=config.json

      - name: ğŸ—ƒï¸ Compress build folder (APK)
        uses: TheDoctor0/zip-release@master
        with:
          filename: build.zip
          directory: cbreez/build/app/outputs/flutter-apk
          type: zip

      - name: ğŸ“¤ Upload asset (APK)
        uses: svenstaro/upload-release-action@v2
        with:
          asset_name: Android-APK.zip
          file: cbreez/build/app/outputs/flutter-apk/build.zip
          overwrite: true
          repo_token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¤ Upload artifact (APK)
        uses: actions/upload-artifact@v3
        with:
          name: Android-APK
          path: cbreez/build/app/outputs/flutter-apk/app-*.apk
